using UnityEngine;
using System;

public class GameManager
{
    // ======================== Singleton ==========================

    private static GameManager _instance = null;
    public static GameManager instance
    {
        get
        {
            if (_instance == null)
                _instance = new GameManager();
            return _instance;
        }
    }

    private GameManager()
    {
        score = 0;
        allowedRevival = 2;
        onUi = true;
    }

    // ======================== External Events ==========================

    public Action scoreChanged;
    public Action<bool> onUiChanged;
    public Action<float> onBallSizeChanged; // 공 크기 확대 효과 적용/시간 갱신 이벤트 (float duration 전달)

    // ------ score functions ------ 

    private float[] timer = new float[4];
    private int blocks = 0;

    private void blockBonus()
    {
        if (timer.Length <= blocks)
        {
            // 2초 안에 5개 블록 충돌시
            if (Time.time - timer[0] <= 2.0)
            {
                score += 50;
                blocks = 0;
            }
            // 2초 초과시 계속 시간 기록
            else
            {
                for (int i = 1; i < timer.Length; i++)
                    timer[i - 1] = timer[i];
                timer[timer.Length - 1] = Time.time;
            }
        }
        else
            timer[blocks++] = Time.time;
    }

    public void addCollisionScore(EntityType type)
    {
        switch (type)
        {
            case EntityType.COIN:
                score += 100;
                break;
            case EntityType.BLOCK_DEFAULT:
            case EntityType.BLOCK_ONE_SHOT:
                blockBonus();
                score += 5;
                break;
        }
    }

    public void addBreakScore(EntityType type)
    {
        switch (type)
        {
            case EntityType.BLOCK_ONE_SHOT:
                score += 30;
                break;
        }
    }

    public void applyBallSizeUp(float duration) // 공 크기 확대 효과 적용 및 지속 시간 설정
    {
        onBallSizeChanged?.Invoke(duration);
    }

    public void cancelBallSizeUp() // 공 크기 확대 효과 해제
    {
        onBallSizeChanged?.Invoke(0f);
    }

    public void invokeCollisionProcess(GameObject go) // 공이 충돌한 오브젝트를 처리하는 중앙 메소드
    {
        if (go.CompareTag("Coin"))
        {
            addCollisionScore(EntityType.COIN);
            UnityEngine.Object.Destroy(go);
            return;
        }

        if (go.CompareTag("ItemSizeUp"))
        {
            applyBallSizeUp(10.0f); // 지속 시간을 10.0초로 설정
            UnityEngine.Object.Destroy(go);
            return;
        }

        if (go.name.Contains("Block"))
        {
            if (go.name.Contains("OneShot"))
            {
                addCollisionScore(EntityType.BLOCK_ONE_SHOT);
            }
            else
            {
                addCollisionScore(EntityType.BLOCK_DEFAULT);
            }
            return;
        }
    }

    // ======================== Game System ==========================

    // ------ properties ------ 

    private int _score;
    public int score { get { return _score; } private set { _score = value; scoreChanged?.Invoke(); } }
    public int allowedRevival { get; private set; }
    private bool _onUi;
    public bool onUi { get { return _onUi; } private set { _onUi = value; onUiChanged?.Invoke(_onUi); } }

    // ------ setter ------ 

    public bool canRevive()
    {
        return (allowedRevival <= 0);
    }

    public void revive()
    {
        if (!canRevive())
            throw new Exception("더 이상 부활할 기회가 없습니다!");
        allowedRevival--;
    }

    public void changeOnUi(bool isOnUi)
    {
        onUi = isOnUi;
    }
}